name: Build Executables

on: [push, pull_request]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk python3-dev libcairo2-dev libpango1.0-dev libgdk-pixbuf2.0-dev shared-mime-info
          # Install additional dependencies for PIL/Pillow
          sudo apt-get install -y libtiff5-dev libjpeg-dev libopenjp2-7-dev zlib1g-dev
          sudo apt-get install -y libfreetype6-dev liblcms2-dev libwebp-dev tcl8.6-dev tk8.6-dev python3-tk
          sudo apt-get install -y libharfbuzz-dev libfribidi-dev libxcb1-dev

      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          python -m pip install --upgrade pip
          pip install wheel

      - name: Create .env file with OpenAI API key
        run: |
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install Pillow first to ensure it's properly configured
          pip install Pillow==9.5.0
          pip install pyinstaller==5.13.0
          pip install -r requirements.txt

      - name: Create GitHub Actions compatible build script
        run: |
          cat > build_github.py << 'EOL'
          #!/usr/bin/env python3
          import os
          import subprocess
          import sys
          import site
          from pathlib import Path

          # Get site-packages directory from the current Python environment
          site_packages = site.getsitepackages()[0]
          print(f"Using site-packages from: {site_packages}")

          # Verify .env file exists
          if os.path.exists('.env'):
              print("Found .env file with content:")
              with open('.env', 'r') as f:
                  print(f.read())
          else:
              print("WARNING: .env file not found!")
              with open('.env', 'w') as f:
                  f.write("OPENAI_API_KEY=dummy_key_for_build")

          # Create a simple spec file
          spec_content = f"""# -*- mode: python ; coding: utf-8 -*-
          import os
          import sys
          from PyInstaller.utils.hooks import collect_all, collect_submodules

          block_cipher = None

          # Create a list of all packages to include
          packages = [
              'tkinterweb', 
              'tkinterdnd2', 
              'PIL', 
              'customtkinter', 
              'markdown', 
              'python-docx', 
              'weasyprint', 
              'openai'
          ]

          # Initialize data collection
          datas = []
          
          # Add .env file - make sure it's included
          if os.path.exists('.env'):
              print("Adding .env file to datas")
              datas.append(('.env', '.'))
          else:
              print("WARNING: .env file not found for packaging!")
              
          # Add assets directory if it exists
          if os.path.exists('assets'):
              datas.append(('assets', 'assets'))
              
          # Add icon if it exists
          if os.path.exists('icon.ico'):
              datas.append(('icon.ico', '.'))
              
          binaries = []
          
          # Add all PIL modules explicitly
          hiddenimports = collect_submodules('PIL')
          hiddenimports.extend([
              'PIL._tkinter_finder',
              'PIL._imagingtk',
              'PIL._imaging',
              'PIL._imagingft',
              'PIL.ImageTk',
              'docx',
          ])

          # Collect all data for each package
          for package in packages:
              try:
                  pkg_datas, pkg_binaries, pkg_hiddenimports = collect_all(package)
                  datas.extend(pkg_datas)
                  binaries.extend(pkg_binaries)
                  hiddenimports.extend(pkg_hiddenimports)
              except Exception as e:
                  print(f"Warning: Error collecting {{package}}: {{e}}")

          # Add tkinter-related files
          if sys.platform.startswith('linux'):
              # Try to find Tcl/Tk libraries on Linux
              tcl_tk_dirs = ['/usr/lib/tcltk', '/usr/share/tcltk', '/usr/lib/tk8.6', '/usr/lib/tcl8.6']
              for d in tcl_tk_dirs:
                  if os.path.exists(d):
                      datas.append((d, os.path.basename(d)))

          a = Analysis(
              ['main.py'],
              pathex=['{site_packages}'],  # Add site-packages to path
              binaries=binaries,
              datas=datas,
              hiddenimports=hiddenimports,
              hookspath=[],
              hooksconfig={{}},
              runtime_hooks=[],
              excludes=[],
              win_no_prefer_redirects=False,
              win_private_assemblies=False,
              cipher=block_cipher,
              noarchive=False,
          )

          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

          # Create a single executable file
          exe = EXE(
              pyz,
              a.scripts,
              a.binaries,
              a.zipfiles,
              a.datas,
              [],
              name='AnalystHub',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=True,
              upx_exclude=[],
              runtime_tmpdir=None,
              console=True,
              icon='icon.ico' if os.path.exists('icon.ico') else None,
          )
          """

          # Write the spec file
          with open('github.spec', 'w') as f:
              f.write(spec_content)

          # Run PyInstaller
          print("Building application with PyInstaller...")
          subprocess.run(['pyinstaller', '--clean', 'github.spec'])

          print("Build completed. Check the 'dist' directory for the executable.")
          EOL
          chmod +x build_github.py
        shell: bash

      - name: Build executable
        run: |
          python build_github.py
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AnalystHub-${{ matrix.os }}
          path: dist/AnalystHub
